<!DOCTYPE html>
<html>
<head>
<title>Sathi Mere - Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<style>
body { font-family: Arial; background: #ffe4f0; margin: 0; padding: 0; overflow: hidden; }

.header {
    background: #ff1493;
    padding: 15px;
    color: white;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-title { 
    text-align: center; 
    flex: 1; 
    font-size: 22px; 
    font-weight: bold; 
    color: white;
}

.wallet-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
    font-weight: bold;
    color: white;
}

.wallet-info img { 
    width: 28px; 
    height: 28px; 
    cursor: pointer; 
    filter: invert(100%) sepia(0%) saturate(0%) hue-rotate(93deg) brightness(105%) contrast(105%);
}

.menu-btn { position: absolute; left: 15px; top: 14px; font-size: 25px; color: white; cursor: pointer; }

.filter-btn {
    position: absolute;
    right: 15px;
    top: 10px;
    background: white;
    color: #ff1493;
    border: 2px solid #ff1493;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
}

.search-box {
    width: 90%;
    display: block;
    padding: 10px 14px;
    border-radius: 10px;
    border: 2px solid #ff1493;
    font-size: 17px;
    outline: none;
    position: fixed;
    top: 70px; /* below header */
    left: 50%;
    transform: translateX(-50%);
    z-index: 9;
    background: #ffe4f0;
}

#menu { width: 0; height: 100%; background: white; position: fixed; top: 0; left: 0; overflow: hidden; transition: 0.3s; z-index: 20; padding-top: 60px; box-shadow: 4px 0 12px rgba(0,0,0,0.3); }
#menu a { display: block; padding: 15px 25px; font-size: 18px; text-decoration: none; color: #444; }
#menu a:hover { background: #ffe1f1; }
.close-menu { position: absolute; top: 12px; right: 15px; font-size: 28px; cursor: pointer; }

.container {
    position: absolute;
    top: 120px; /* header + search bar */
    bottom: 60px; /* above bottom nav */
    width: 100%;
    overflow-y: auto;
    padding: 0 15px 20px 15px;
}

.user-card {
    background: white;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 0 10px #ffc0d9;
    display: flex;
    align-items: center;
    position: relative;
}

.user-card img {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #ff1493;
    margin-right: 15px;
}

.name { font-weight: bold; color: #ff1493; }

.btn { background: #ff1493; color: white; border: none; border-radius: 8px; margin-top: 5px; padding: 7px 12px; cursor: pointer; }
.btn-disabled { background: gray; }

/* Online Dot */
.online-dot { position:absolute; width:12px; height:12px; border-radius:50%; background:green; top:0; right:0; border:2px solid white; }

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: #ff1493;
    display: flex;
    justify-content: space-around;
    border-top: 2px solid gold;
    border-left: 2px solid gold;
    border-right: 2px solid gold;
    padding: 8px 0;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

.nav-item { text-align: center; color: gold; font-weight: bold; position: relative; }
.nav-item span { font-size: 26px; display: block; color: gold; }

/* Unread badge */
.unread-badge {
    position: absolute;
    top: 2px;
    right: 18px;
    background: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 50%;
    min-width: 18px;
    text-align: center;
    line-height: 14px;
}
</style>
</head>
<body>

<div class="header">
<span class="menu-btn" onclick="openMenu()">‚ò∞</span>

<div class="header-title">Sathi Mere</div>

<div class="wallet-info">
  <span>‚Çπ <span id="walletBalance">0</span></span>
  <img src="https://i.imgur.com/3y3GdFm.png" alt="Recharge" onclick="location.href='wallet.html'">
</div>
</div>

<input id="searchInput" class="search-box" placeholder="Search by name..." onkeyup="searchUser()">

<div id="menu">
<span class="close-menu" onclick="closeMenu()">‚úñ</span>

<a href="profile.html">My Profile</a>
<a href="wallet.html">Wallet</a>
<a href="like.html">Likes</a>
<a href="chat.html">Chats</a>
<a href="referral.html">Referral</a>
<a href="help.html">Help & Support</a>
<a href="privacy.html">Privacy Policy</a>
<a href="social.html">Social Media</a>
<a href="about.html">About</a>
<a onclick="logout()">Logout</a>
</div>

<div class="container" id="userList">Loading...</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="location.href='like.html'">
        <span id="navHeart">ü§ç</span> Like
    </div>
    <div class="nav-item" onclick="location.href='chat.html'">
        <span>üí¨</span> Chat
        <div id="unreadCount" class="unread-badge" style="display:none;">0</div>
    </div>
    <div class="nav-item" onclick="location.href='profile.html'">
        <span>üë§</span> Profile
    </div>
</div>

<script>
function openMenu(){ menu.style.width = "260px"; }
function closeMenu(){ menu.style.width = "0"; }

auth.onAuthStateChanged(async (user) => {
    if(!user) return window.location="login.html";
    loadUsers(user.uid);
    updateUnread(user.uid);
    loadWallet(user.uid);
});

let ALL_USERS = [];

async function loadWallet(uid){
    const snap = await db.collection("wallets").doc(uid).get();
    const bal = snap.exists ? snap.data().balance : 0;
    document.getElementById("walletBalance").innerText = bal;
}

/* Users Load */
async function loadUsers(myId) {
    const list = document.getElementById("userList");
    list.innerHTML = "Loading...";
    let me = await db.collection("users").doc(myId).get();
    let myGender = me.data().gender;
    let opposite = myGender === "Male" ? "Female" : "Male";
    db.collection("users").where("gender","==",opposite)
    .onSnapshot(async snap=>{
        list.innerHTML="";
        ALL_USERS=[];
        for(let doc of snap.docs){
            let u = doc.data();
            u.uid = doc.id;
            ALL_USERS.push(u);
        }
        await renderUsers(ALL_USERS, myId);
    });
}

/* Unread Count */
async function updateUnread(myId){
    const chatsSnap = await db.collection("chatRequests")
        .where("status","==","accepted")
        .get();
    let unreadTotal = 0;
    for(let doc of chatsSnap.docs){
        const data = doc.data();
        const fromId = data.from;
        const toId = data.to;
        const chatID = fromId < toId ? fromId+"_"+toId : toId+"_"+fromId;
        const messagesSnap = await db.collection("chats").doc(chatID).collection("messages")
            .where("to","==",myId)
            .where("seen","==",false)
            .get();
        unreadTotal += messagesSnap.size;
    }
    const badge = document.getElementById("unreadCount");
    if(unreadTotal>0){
        badge.style.display="block";
        badge.innerText=unreadTotal;
    } else {
        badge.style.display="none";
    }
    setTimeout(()=>updateUnread(myId),3000);
}

/* Render Users */
async function renderUsers(users, myId) {
    const list = document.getElementById("userList");
    list.innerHTML="";
    for(let u of users){
        let uid = u.uid;
        const card = document.createElement("div");
        card.className="user-card";

        const imgWrapper = document.createElement("div");
        imgWrapper.style.position="relative";
        const img = document.createElement("img");
        img.src = u.photo || 'https://i.imgur.com/6VBx3io.png';
        imgWrapper.appendChild(img);

        const chatID = myId < uid ? myId+"_"+uid : uid+"_"+myId;
        db.collection("chats").doc(chatID).onSnapshot(doc=>{
            const dot = imgWrapper.querySelector(".online-dot");
            const isOnline = doc.exists ? doc.data()[uid+"_online"]===true : false;
            if(isOnline){
                if(!dot){
                    const d = document.createElement("div");
                    d.className="online-dot";
                    imgWrapper.appendChild(d);
                }
            } else {
                if(dot) dot.remove();
            }
        });

        card.appendChild(imgWrapper);

        const infoDiv = document.createElement("div");
        infoDiv.style.flex="1";
        infoDiv.innerHTML=`
            <div class="name">${u.name} ${u.surname}</div>
            <div style="color:gray">${u.gender}</div>
            <button id="like_${uid}" class="btn" onclick="toggleLike('${uid}','${u.name}','${u.photo}')">ü§ç Like</button>
            <button class="btn" onclick="viewProfile('${uid}')">üëÄ View Profile</button>
            <button id="btn_${uid}" class="btn">‚úâ Chat Request</button>
        `;
        card.appendChild(infoDiv);

        list.appendChild(card);

        checkStatus(myId, uid);
        document.getElementById("btn_" + uid).onclick = () => sendRequest(myId, uid, u.gender);
    }
}

/* Like System */
async function toggleLike(uid,name,photo){
    let myId = auth.currentUser.uid;
    let btn = document.getElementById("like_" + uid);
    let exists = await db.collection("likes")
        .where("from","==",myId)
        .where("to","==",uid)
        .get();
    if(!exists.empty){
        btn.innerHTML="‚ù§Ô∏è Liked";
        return;
    }
    await db.collection("likes").add({
        from: myId,
        to: uid,
        name: name,
        photo: photo,
        time: Date.now()
    });
    btn.innerHTML="‚ù§Ô∏è Liked";
    document.getElementById("navHeart").innerHTML="‚ù§Ô∏è";
}

function searchUser(){
    const text=document.getElementById("searchInput").value.toLowerCase();
    let filtered=ALL_USERS.filter(u=>
        u.name.toLowerCase().includes(text) || u.surname.toLowerCase().includes(text)
    );
    renderUsers(filtered,auth.currentUser.uid);
}

function viewProfile(uid){
    window.location="view-profile.html?id="+uid;
}

/* Status Check */
async function checkStatus(myId,otherId){
    let btn=document.getElementById("btn_"+otherId);
    let doc=await db.collection("chatRequests").doc(myId+"_"+otherId).get();
    if(doc.exists){
        let status=doc.data().status;
        if(status==="pending"){
            btn.innerText="Request Sent";
            btn.disabled=true;
            btn.classList.add("btn-disabled");
        }
        if(status==="accepted"){
            btn.innerText="Chat Now";
            btn.onclick=()=>window.location="chat-room.html?id="+(myId<otherId ? myId+"_"+otherId : otherId+"_"+myId);
        }
    }
}

/* Chat Request */
async function sendRequest(myId,toId,otherGender){
    let me = await db.collection("users").doc(myId).get();
    let myGender = me.data().gender;
    if(myGender==="Female"){
        await db.collection("chatRequests").doc(myId+"_"+toId).set({
            from: myId,
            to: toId,
            status: "pending",
            timestamp: Date.now(),
            paidBy: "Male"
        });
        alert("Chat request sent! (Female = Free)");
        checkStatus(myId,toId);
        return;
    }
    let wallet = await db.collection("wallets").doc(myId).get();
    let balance = wallet.exists ? wallet.data().balance : 0;
    if(balance < 10){
        alert("Insufficient balance! Please add money.");
        return;
    }
    await db.collection("wallets").doc(myId).update({
        balance: balance - 10
    });
    await db.collection("chatRequests").doc(myId+"_"+toId).set({
        from: myId,
        to: toId,
        status: "pending",
        timestamp: Date.now(),
        paidBy: "Male"
    });
    await db.collection("history").add({
        uid: myId,
        amount: -10,
        type: "Chat Request",
        time: new Date()
    });
    alert("Chat request sent! ‚Çπ10 deducted.");
    checkStatus(myId,toId);
}

/* Logout */
function logout(){
    auth.signOut().then(()=>{window.location="login.html"});
}
</script>

</body>
    </html>
